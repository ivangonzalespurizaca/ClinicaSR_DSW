@model IEnumerable<ClinicaSR.BL.BE.CitaBE>

@{
    ViewData["Title"] = "Listado de Citas";
    Layout = "~/Views/Shared/_LayoutRecepcionista.cshtml";
    var texto = ViewBag.texto as string;
}

<style>
    /* Diseño Minimalista y Profesional */
    .page-container {
        margin-top: 1.5rem;
    }

    .card-modern {
        border: none;
        border-radius: 12px;
        background: #ffffff;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

        .card-modern .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #edf2f7;
            padding: 1.25rem 1.5rem;
            border-radius: 12px 12px 0 0;
        }

    .card-title {
        color: #2d3748;
        font-weight: 600;
        margin-bottom: 0;
    }

    /* Tabla Estilizada */
    .table-modern thead th {
        background-color: #f8fafc;
        color: #4a5568;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.025em;
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem;
    }

    .table-modern tbody td {
        padding: 1rem;
        color: #4a5568;
        vertical-align: middle;
        border-bottom: 1px solid #edf2f7;
    }

    /* Badges de Estado más sobrios */
    .badge-status {
        padding: 0.4em 0.8em;
        font-weight: 500;
        border-radius: 6px;
        font-size: 0.85rem;
    }

    .st-confirmado {
        background-color: #def7ec;
        color: #03543f;
    }

    .st-pendiente {
        background-color: #fef3c7;
        color: #92400e;
    }

    .st-cancelado {
        background-color: #fde8e8;
        color: #9b1c1c;
    }

    /* Buscador */
    .search-group .form-control {
        border-radius: 8px 0 0 8px;
        border: 1px solid #e2e8f0;
    }

    .search-group .btn {
        border-radius: 0 8px 8px 0;
    }

    .btn-action {
        border-radius: 8px;
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
</style>

<div class="page-container container-fluid px-4">
    <div class="card card-modern">

        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title">
                <i class="bi bi-calendar3 me-2 text-primary"></i>Gestión de Citas Médicas
            </h5>
            <div class="header-actions">
                <a asp-controller="Cita" asp-action="RegistrarCita" class="btn btn-primary btn-action shadow-sm">
                    <i class="bi bi-plus-lg me-1"></i> Registrar Cita
                </a>
            </div>
        </div>

        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <form asp-action="Listar" asp-controller="Cita" method="get">
                        <div class="input-group search-group">
                            <span class="input-group-text bg-white border-end-0 text-muted">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" name="texto" class="form-control border-start-0 ps-0"
                                   placeholder="Buscar por nombre o DNI..." value="@texto">
                            <button class="btn btn-outline-primary" type="submit">Buscar</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <a href="/citas/ReporteCitas" class="btn btn-outline-secondary btn-action" target="_blank">
                        <i class="bi bi-file-earmark-text me-1"></i> Generar Reporte
                    </a>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover table-modern">
                    <thead>
                        <tr>
                            <th>DNI Paciente</th>
                            <th>Paciente</th>
                            <th>Médico</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var cita in Model)
                            {
                                <tr>
                                    <td class="fw-medium text-dark">@cita.PacienteBE.DNI</td>
                                    <td>@cita.PacienteBE.Nombres</td>
                                    <td><span class="small fw-bold text-secondary">@cita.MedicoBE.Nombres</span></td>
                                    <td>@cita.Fecha_Cita.ToString("dd/MM/yyyy")</td>
                                    <td><i class="bi bi-clock me-1 text-muted small"></i> @cita.Hora_Cita.ToString(@"hh\:mm")</td>
                                    <td>
                                        @{
                                            var badgeStyle = cita.Estado switch
                                            {
                                                ClinicaSR.BL.BE.EstadoCita.CONFIRMADO => "st-confirmado",
                                                ClinicaSR.BL.BE.EstadoCita.PENDIENTE => "st-pendiente",
                                                ClinicaSR.BL.BE.EstadoCita.CANCELADO => "st-cancelado",
                                                _ => "bg-light text-muted"
                                            };
                                        }
                                        <span class="badge-status @badgeStyle">@cita.Estado</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group gap-1">
                                            <button class="btn btn-light btn-sm text-primary border" onclick="verDetalleCita(@cita.ID_Cita)" title="Ver Detalle">
                                                <i class="bi bi-eye"></i>
                                            </button>

                                            @if (cita.Estado == ClinicaSR.BL.BE.EstadoCita.PENDIENTE || cita.Estado == ClinicaSR.BL.BE.EstadoCita.CONFIRMADO)
                                            {
                                                <a asp-action="EditarCita" asp-route-id="@cita.ID_Cita" class="btn btn-light btn-sm text-warning border" title="Editar">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>

                                                <button type="button" class="btn btn-light btn-sm text-danger border" onclick="confirmarEliminar('@cita.ID_Cita')" title="Anular">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>

                                                <form id="form-cancelar-@cita.ID_Cita" asp-action="Cancelar" asp-controller="Cita" asp-route-id="@cita.ID_Cita" method="post" style="display:none;"></form>
                                            }
                                            else
                                            {
                                                <button class="btn btn-light btn-sm text-muted border" disabled><i class="bi bi-pencil-square"></i></button>
                                                <button class="btn btn-light btn-sm text-muted border" disabled><i class="bi bi-x-circle"></i></button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-5 text-muted">No hay citas registradas.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalleCita" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0">
                <h6 class="modal-title fw-bold"><i class="bi bi-info-circle me-2 text-info"></i>Detalles de la Cita</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="contenidoModalDetalle" class="modal-body p-4 text-center">
                <div class="spinner-border text-info" role="status"></div>
                <p class="mt-2">Cargando información...</p>
            </div>
            <div class="modal-footer border-top-0 bg-light">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/citas.js"></script>

    <script>
        const successMsg = '@ViewBag.Success';
        const errorMsg = '@ViewBag.Error';

        if (successMsg) Swal.fire("Éxito", successMsg, "success");
        if (errorMsg) Swal.fire("Error", errorMsg, "error");

        function confirmarEliminar(id) {
            Swal.fire({
                title: "¿Anular cita?",
                text: "La cita pasará a estado CANCELADO permanentemente.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#f8f9fa",
                confirmButtonText: "Sí, anular",
                cancelButtonText: "Regresar",
                customClass: { cancelButton: 'text-dark border' }
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById(`form-cancelar-${id}`).submit();
                }
            });
        }
    </script>
}